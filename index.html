<!DOCTYPE html>
<html>
<head>
<title>DermalScan AI</title>

<style>
body { background:#0b1025; color:white; font-family:Arial; text-align:center; }
button { background:#00e1ff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }
.container { max-width:1100px; margin:auto; }
.grid { display:flex; gap:20px; margin-top:20px; }
.card { flex:1; background:#121b3a; padding:15px; border-radius:12px; }
img { max-width:100%; border-radius:8px; }
.info-box { margin-top:10px; background:#0f2235; padding:10px; border-radius:8px; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { border:1px solid #333; padding:6px; }
th { background:#00e1ff; color:black; }
.hidden { display:none; }
</style>
</head>

<body>

<h1>DermalScan AI â€“ Skin & Age Analysis</h1>

<input type="file" id="upload">
<br><br>
<button onclick="startAnalysis()">Start Analysis</button>

<div id="result" class="hidden container">

<div class="grid">
    <div class="card">
        <h3>Before</h3>
        <img id="beforeImg">
        <br><br>
        <a id="downloadBefore" download="before.jpg">
            <button>Download</button>
        </a>
    </div>

    <div class="card">
        <h3>After</h3>
        <div class="info-box">
            <b>Problem:</b> <span id="lbl"></span> |
            <b>Age:</b> <span id="age"></span> |
            <b>Confidence:</b> <span id="conf"></span> |
            <b>Analysis Time:</b> <span id="analysisTime"></span>
        </div>
        <img id="afterImg">
        <br><br>
        <a id="downloadAfter" download="after.jpg">
            <button>Download</button>
        </a>
    </div>
</div>

<h3>Prediction Table</h3>
<table>
<thead>
<tr>
<th>X1</th><th>Y1</th><th>X2</th><th>Y2</th>
<th>Class</th><th>Confidence</th><th>Age</th>
</tr>
</thead>
<tbody id="predTable"></tbody>
</table>

<button onclick="downloadCSV()">Download CSV</button>

<h3>History</h3>
<button onclick="clearHistory()">Clear History</button>

<table>
<thead>
<tr><th>Time</th><th>Image</th><th>Class</th><th>Conf</th><th>Age</th></tr>
</thead>
<tbody id="history"></tbody>
</table>

</div>

<script>
let history = [];

function startAnalysis(){
    const file = upload.files[0];
    if(!file){ alert("Upload image"); return; }

    beforeImg.src = URL.createObjectURL(file);
    downloadBefore.href = beforeImg.src;

    const fd = new FormData();
    fd.append("image", file);

    fetch("http://127.0.0.1:5000/analyze",{ method:"POST", body:fd })
    .then(r=>r.json())
    .then(async out=>{
        result.classList.remove("hidden");

        afterImg.src = out.image;
        let imgBlob = await fetch(out.image).then(r => r.blob());
        downloadAfter.href = URL.createObjectURL(imgBlob);

        if(out.detections && out.detections.length > 0){
            lbl.innerText = out.detections[0].label;
            age.innerText = out.detections[0].age;
            conf.innerText = out.detections[0].confidence;
        }
        analysisTime.innerText = out.analysis_time || "N/A";

        predTable.innerHTML += out.detections.map(d => `
        <tr>
        <td>${d.box.x1}</td><td>${d.box.y1}</td>
        <td>${d.box.x2}</td><td>${d.box.y2}</td>
        <td>${d.label}</td><td>${d.confidence}</td><td>${d.age}</td>
        </tr>`).join("");

        history.unshift(out);
        renderHistory();
    });
}

function renderHistory(){
    document.getElementById("history").innerHTML = history.flatMap(h =>
        (h.detections || []).map(d => `
    <tr>
        <td>${h.timestamp}</td>
        <td><a href="${h.image}" download="annotated_${h.timestamp.replace(/[: ]/g, '_')}.jpg"><img src="${h.image}" style="max-width:50px; max-height:50px; cursor:pointer;"></a></td>
        <td>${d.label}</td>
        <td>${d.confidence}</td>
        <td>${d.age}</td>
    </tr>`).join("")
    ).join("");
}

function clearHistory(){
    history = [];
    document.getElementById("history").innerHTML = "";
}

function downloadCSV(){
    let csv = "x1,y1,x2,y2,class,confidence,age\n";
    history.forEach(h=>{
        if(h.detections){
            h.detections.forEach(d=>{
                csv += `${d.box.x1},${d.box.y1},${d.box.x2},${d.box.y2},${d.label},${d.confidence},${d.age}\n`;
            });
        }
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="predictions.csv";
    a.click();
}
</script>

</body>
</html>
